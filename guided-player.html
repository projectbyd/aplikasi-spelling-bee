<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Spelling Bee ‚Äì Guided Mode</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Henny+Penny&family=Comfortaa&display=swap" rel="stylesheet">

<style>
html,body{
  margin:0;
  padding:0;
  font-family:'Comfortaa', system-ui, sans-serif;
  background:#eef6f1;
}

:root{
  --blue:#38b6ff;
  --yellow:#f2e590;
  --btn-h:44px;
}

/* ===== HEADER ===== */
#top{
  position:fixed;
  inset:0 0 auto 0;
  padding:18px 14px;
  background:url("header-bg.png") center/cover no-repeat;
  z-index:1000;
}
#top::before{
  content:"";
  position:absolute;
  inset:0;
  background:rgba(255,255,255,.35);
  pointer-events:none;
}
#title,#subtitle,#topBtns{
  position:relative;
  z-index:1;
}
#title{
  font-family:'Henny Penny', cursive;
  text-align:center;
  font-size:34px;
  color:var(--blue);
}
#subtitle{
  font-size:12px;
  text-align:center;
  color:var(--blue);
  margin-bottom:10px;
}
#topBtns{
  display:none;
  gap:8px;
}
.btn{
  flex:1;
  height:var(--btn-h);
  border:none;
  border-radius:12px;
  background:#fff;
  color:var(--blue);
  font-weight:900;
}

/* ===== TABLE ===== */
.wrapper{
  position:fixed;
  top:280px;
  bottom:90px;
  inset-inline:0;
  overflow-y:auto;
}
table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #ddd;
  background:#fff;
}
tr.active td{background:#fff3bf;}
.word{font-weight:800;}
.spellBtn{
  border:none;
  background:#edf4dc;
  padding:6px 10px;
  border-radius:10px;
}

/* ===== BOTTOM ===== */
#bottom{
  position:fixed;
  bottom:0;
  inset-inline:0;
  background:#edf4dc;
  display:flex;
  gap:6px;
  padding:8px;
}
.bottom-btn{
  flex:1;
  height:var(--btn-h);
  border-radius:18px;
  background:var(--yellow);
  color:var(--blue);
  font-weight:900;
  border:none;
}
#timer{display:none}

/* ===== POPUP ===== */
#helpOverlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
#helpBox{
  background:#edf4dc;
  padding:16px;
  width:88%;
  max-width:360px;
  border-radius:20px;
}
</style>
</head>

<body>

<!-- HEADER -->
<div id="top">
  <div id="title">GUIDED MODE</div>
  <div id="subtitle">
    ‚ñ∂Ô∏è START = baca otomatis (20 detik)<br>
    üîä SPEAK = jawab lisan<br>
    üî† SPELL = ejaan huruf
  </div>

  <div id="topBtns">
    <button class="btn" onclick="playAll()">‚ñ∂Ô∏è START</button>
    <button class="btn" onclick="pauseResume()">‚è∏ PAUSE</button>
    <button class="btn" onclick="stopAll()">‚èπ STOP</button>
  </div>
</div>

<!-- TABLE -->
<div class="wrapper">
<table>
<thead id="tableHead" style="display:none">
<tr>
  <th>No</th><th>Word</th><th>Sentence</th><th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>

<!-- BOTTOM -->
<div id="bottom">
  <button class="bottom-btn" onclick="goBack()">‚¨Ö KEMBALI</button>
  <button class="bottom-btn" onclick="openHelp()">INSTRUCTION</button>
  <button class="bottom-btn" id="timer">‚è±Ô∏è 20</button>
</div>

<!-- HELP -->
<div id="helpOverlay" onclick="closeHelp(event)">
  <div id="helpBox">
    <h3>Cara Menggunakan</h3>
    <p>START ‚Üí baca otomatis + timer</p>
    <p>SPEAK ‚Üí dengar 1 soal</p>
    <p>SPELL ‚Üí eja huruf</p>
    <button class="bottom-btn" onclick="closeHelp()">OK</button>
  </div>
</div>

<script>
/* ===== STATE ===== */
let rows=[], current=0, playing=false, paused=false;
let timerInt=null, audioCtx=null;

/* ===== AUDIO ===== */
function initAudio(){
  if(!audioCtx){
    audioCtx=new (window.AudioContext||webkitAudioContext)();
  }
  speechSynthesis.cancel();
  speechSynthesis.speak(new SpeechSynthesisUtterance(" "));
}

/* ===== UTIL ===== */
function wait(ms){return new Promise(r=>setTimeout(r,ms));}
function speak(t){
  return new Promise(res=>{
    const u=new SpeechSynthesisUtterance(t);
    u.lang="en-US";
    u.onend=res;
    speechSynthesis.speak(u);
  });
}

/* ===== TIMER ===== */
function clearTimer(){clearInterval(timerInt)}
function timer20(){
  return new Promise(res=>{
    clearTimer();
    let t=20;
    timer.textContent="‚è±Ô∏è "+t;
    timerInt=setInterval(()=>{
      if(paused) return;
      t--; timer.textContent="‚è±Ô∏è "+t;
      if(t===0){clearTimer();res();}
    },1000);
  });
}

/* ===== RENDER ===== */
function render(){
  tbody.innerHTML="";
  rows.forEach((r,i)=>{
    tbody.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td class="word">${r[1]}</td>
        <td>${r[2]}</td>
        <td>
          <button class="spellBtn" onclick="speakRow(${i})">üîä</button>
          <button class="spellBtn" onclick="spell(${i})">üî†</button>
        </td>
      </tr>`;
  });
}

/* ===== PLAY ===== */
async function playRow(i){
  await speak(rows[i][1]);
  await wait(400);
  await speak(rows[i][2]);
  await wait(400);
  await speak(rows[i][1]);
  await timer20();
}
async function playAll(){
  initAudio();
  playing=true;
  for(current=0;current<rows.length && playing;current++){
    await playRow(current);
  }
}
function stopAll(){
  playing=false;
  speechSynthesis.cancel();
  clearTimer();
  timer.textContent="‚è±Ô∏è 20";
}
function pauseResume(){
  paused=!paused;
  paused?speechSynthesis.pause():speechSynthesis.resume();
}
async function speakRow(i){
  stopAll();
  await speak(rows[i][1]);
  await speak(rows[i][2]);
}
async function spell(i){
  stopAll();
  for(const c of rows[i][1]) await speak(c);
}

/* ===== LOAD LEVEL ===== */
async function loadInternalCSV(level){
  initAudio();
  const res=await fetch(data/level${level}.csv);
  const txt=await res.text();
  rows=txt.trim().split("\n").slice(1).map(l=>l.split(","));
  render();
  topBtns.style.display="flex";
  tableHead.style.display="table-header-group";
  timer.style.display="flex";
}

/* ===== UI ===== */
function goBack(){location.href="guided-level.html";}
function openHelp(){helpOverlay.style.display="flex";}
function closeHelp(e){
  if(!e||e.target.id==="helpOverlay")helpOverlay.style.display="none";
}

/* ===== INIT ===== */
document.addEventListener("DOMContentLoaded",()=>{
  const level=new URLSearchParams(location.search).get("level");
  if(level) loadInternalCSV(level);
});
</script>

</body>
</html>
